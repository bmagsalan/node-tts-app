<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech</title>
    <style>
        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <h1>Text-to-Speech</h1>
    <textarea id="textInput" rows="10" cols="50">This program allows you to convert text into speech. Simply enter your desired text in the textarea below, then click the "Convert to Speech" button. The program will then send the text to the server, where it will be converted into audio. Once the audio is generated, you can play it using the audio player provided.</textarea>
    <br>
    <button id="convertButton">Convert to Speech</button>
    <audio id="audioPlayer" controls></audio>

    <script>
        const convertButton = document.getElementById('convertButton');
        const textInput = document.getElementById('textInput');
        const audioPlayer = document.getElementById('audioPlayer');

        let sentences = []; // Array to store sentences
        let currentSentenceIndex = 0; // Index of the current sentence being read

        // Function to split text into sentences
        const splitTextIntoSentences = (text) => {
            return text.match(/[^\.!\?]+[\.!\?]+/g);
        };

        // Event listener for the convert button
        convertButton.addEventListener('click', async () => {
            let text = textInput.value.trim();
            if (text === '') {
                alert('Please enter some text to convert.');
                return;
            }

            // Split text into sentences
            sentences = splitTextIntoSentences(text);

            // Escape special characters
            text = text.replace(/\\/g, '\\\\')
                       .replace(/"/g, '\\"');

            // Send the first sentence to the server to convert to speech
            await speakNextSentence();
        });

        // Function to speak the next sentence
        const speakNextSentence = async () => {
            if (currentSentenceIndex >= sentences.length) {
                // All sentences have been spoken
                console.log('All sentences have been spoken.');
                return;
            }

            // Get the next sentence
            const nextSentence = sentences[currentSentenceIndex];

            // Highlight the current sentence in the text area
            highlightSentence(nextSentence);

            // Send the next sentence to the server to convert to speech
            const response = await fetch('/text-to-speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: nextSentence })
            });

            if (!response.ok) {
                console.error('Error converting text to speech:', response.statusText);
                return;
            }

            // Play the audio received from the server
            const audioBlob = await response.blob();
            audioPlayer.src = URL.createObjectURL(audioBlob);
            audioPlayer.play();

            // Increment the current sentence index
            currentSentenceIndex++;

            // Listen for the end of audio playback
            audioPlayer.addEventListener('ended', () => {
                // Unselect the text after the sentence is read
                unhighlightSentence(nextSentence);
                speakNextSentence();
            });
        };

        // Function to highlight a sentence in the text area
        const highlightSentence = (sentence) => {
            const text = textInput.value;
            const startIndex = text.indexOf(sentence);
            const endIndex = startIndex + sentence.length;
            textInput.setSelectionRange(startIndex, endIndex);
            textInput.focus();
            document.execCommand('highlight');
        };

        // Function to unhighlight a sentence in the text area
        const unhighlightSentence = (sentence) => {
            const text = textInput.value;
            const startIndex = text.indexOf(sentence);
            const endIndex = startIndex + sentence.length;
            textInput.setSelectionRange(startIndex, endIndex);
            document.execCommand('unhighlight');
        };
    </script>
</body>
</html>
